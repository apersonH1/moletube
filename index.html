<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>YouTube → nocookie embed logger</title>
  <style>
    body {
      font-family: system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial;
      padding: 20px;
      max-width: 900px;
      margin: auto;
    }
    input[type="text"] { width: 80%; padding: 8px; font-size: 16px; }
    button { padding: 8px 12px; font-size: 16px; margin-left: 8px; cursor: pointer; }
    iframe { width: 100%; height: 360px; border: 0; border-radius: 8px; margin-top: 12px; }
    .embed, .log-item { margin-top: 18px; }
    .log-item { border: 1px solid #ddd; padding: 10px; border-radius: 6px; }
  </style>
</head>
<body>
  <h1>Convert YouTube → youtube-nocookie embed</h1>

  <p>Paste any YouTube link below and click <strong>Convert & Log</strong> to share it.</p>

  <div>
    <input id="inputUrl" placeholder="https://www.youtube.com/watch?v=dQw4w9WgXcQ" />
    <button id="convertBtn">Convert & Log</button>
  </div>

  <div id="result" class="embed"></div>

  <h2>Logged videos</h2>
  <div id="logged"></div>

<script>
// =============== URL PARSER ===================
function parseYouTubeUrl(urlString) {
  try {
    const url = new URL(urlString);
    const host = url.hostname.replace(/^www\./, '');
    let videoId = null;

    if (host.includes('youtu.be')) {
      videoId = url.pathname.slice(1);
    } else if (host.includes('youtube.com')) {
      videoId = url.searchParams.get('v');
      if (!videoId && url.pathname.includes('/embed/')) {
        videoId = url.pathname.split('/embed/')[1];
      }
    }
    return videoId ? videoId.replace(/[^A-Za-z0-9_-]/g, '') : null;
  } catch {
    return null;
  }
}

function makeNoCookieUrl(id) {
  return `https://www.youtube-nocookie.com/embed/${id}`;
}

// =============== UI FUNCTIONS ===================
function createEmbed(src) {
  const div = document.createElement('div');
  div.className = 'log-item';
  div.innerHTML = `
    <a href="${src}" target="_blank">${src}</a><br>
    <iframe src="${src}" allowfullscreen></iframe>
  `;
  return div;
}

// =============== SERVER CALLS ===================
async function postLog(url) {
  try {
    await fetch('/api/log', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ url })
    });
  } catch (err) {
    console.error('Error logging URL:', err);
  }
}

async function loadLogs() {
  const container = document.getElementById('logged');
  container.innerHTML = '<p><em>Loading logged videos...</em></p>';
  try {
    const res = await fetch('/api/list');
    const data = await res.json();
    container.innerHTML = '';
    if (data.length === 0) {
      container.innerHTML = '<p><em>No videos logged yet.</em></p>';
      return;
    }
    data.slice().reverse().forEach(item => {
      container.appendChild(createEmbed(item.url));
    });
  } catch (err) {
    container.innerHTML = '<p style="color:red;">Failed to load logs.</p>';
    console.error(err);
  }
}

// =============== MAIN BUTTON HANDLER ===================
document.getElementById('convertBtn').addEventListener('click', async () => {
  const input = document.getElementById('inputUrl').value.trim();
  if (!input) return alert('Paste a YouTube URL first.');

  const id = parseYouTubeUrl(input);
  if (!id) return alert('Invalid YouTube URL.');

  const embedUrl = makeNoCookieUrl(id);
  document.getElementById('result').innerHTML = '';
  document.getElementById('result').appendChild(createEmbed(embedUrl));

  await p
