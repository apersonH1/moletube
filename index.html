<!doctype html>
<html>
<head>
<meta charset="utf-8">
<title>YouTube NoCookie Converter</title>
<style>
  body { font-family: sans-serif; background: #f4f6fb; display: flex; justify-content: center; padding: 2rem; }
  .box { background: #fff; padding: 2rem; border-radius: 12px; width: 100%; max-width: 600px; box-shadow: 0 4px 18px rgba(0,0,0,.1); }
  input { width: 100%; padding: 10px; border: 1px solid #ccc; border-radius: 8px; margin-top: 10px; font-size: 16px; }
  button { margin-top: 10px; padding: 10px 20px; background: #0b74ff; color: white; border: none; border-radius: 8px; cursor: pointer; font-size: 16px; }
  iframe { width: 100%; height: 315px; margin-top: 15px; border-radius: 8px; border: none; }
  .log-item { margin-top: 10px; padding: 10px; border: 1px solid #ddd; border-radius: 8px; background: #fafbff; }
</style>
</head>
<body>
  <div class="box">
    <h2>YouTube ➜ NoCookie Converter</h2>
    <input id="urlInput" placeholder="Paste YouTube link here">
    <button id="convertBtn">Convert & Log</button>
    <div id="result"></div>

    <h3>Logged videos</h3>
    <div id="logList">Loading...</div>
  </div>

<script>
function extractYouTubeId(url) {
  try {
    const parsed = new URL(url);
    if (parsed.hostname.includes("youtu.be")) return parsed.pathname.slice(1);
    if (parsed.searchParams.get("v")) return parsed.searchParams.get("v");
    const match = parsed.pathname.match(/\/embed\/([^/?]+)/) || parsed.pathname.match(/\/shorts\/([^/?]+)/);
    return match ? match[1] : null;
  } catch {
    return null;
  }
}

function makeNoCookieUrl(id) {
  return `https://www.youtube-nocookie.com/embed/${id}`;
}

async function logUrl(url) {
  await fetch("/api/log", {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify({ url })
  });
}

async function loadLogs() {
  const res = await fetch("/api/list");
  const data = await res.json();
  const logList = document.getElementById("logList");
  logList.innerHTML = "";
  data.reverse().forEach(entry => {
    const div = document.createElement("div");
    div.className = "log-item";
    div.innerHTML = `
      <a href="${entry.url}" target="_blank">${entry.url}</a><br>
      <iframe src="${entry.url}" allowfullscreen></iframe>
    `;
    logList.appendChild(div);
  });
}

document.getElementById("convertBtn").addEventListener("click", async () => {
  const input = document.getElementById("urlInput").value.trim();
  if (!input) return alert("Enter a YouTube URL");

  const id = extractYouTubeId(input);
  if (!id) return alert("That doesn’t look like a valid YouTube URL.");

  const noCookie = makeNoCookieUrl(id);
  document.getElementById("result").innerHTML = `
    <p><b>NoCookie URL:</b> <a href="${noCookie}" target="_blank">${noCookie}</a></p>
    <iframe src="${noCookie}" allowfullscreen></iframe>
  `;
  await logUrl(noCookie);
  await loadLogs();
});

loadLogs();
</script>
</body>
</html>
